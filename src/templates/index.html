<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiliBili Video Downloader</title>
    <link rel="stylesheet" href="./static/style.css">
</head>
<body>
    <div id="app">
        <div class="logo">
            <img src="./static/assets/BILIBILI_LOGO.svg" draggable="false" />
        </div>
        <div class="input_search">
            <input type="text" id="videoUrl" placeholder="请输入视频链接或BV号..." />
            <button id="downloadBtn">获取</button>
        </div>
        <div class="use-info">
            <div id="collapse">
                <div id="videoUrlInfo" style="display:none;">
                    <h3>视频标题</h3>
                    <p id="videoName"></p>
                    <div id="imgUrlInfo" style="display:none;">
                        <h3>预览封面</h3>
                        <p id="imgUrl"></p>
                        <p>
                            <a rel="noreferrer" id="previewImage" href="#" target="_blank">预览图片</a>
                        </p>
                    </div>
                    <p>
                        <a id="previewVideo" href="#" target="_blank">预览视频</a>
                        <a id="downloadVideo" href="#" target="_blank" download>下载视频</a>
                    </p>
                </div>
                <div id="usageInfo">
                    <h3>使用说明</h3>
                    <p>1. 手机，复制视频链接即可</p>
                    <p>2. 电脑，复制地址栏地址即可</p>
                    <p>3. 图片可以长按进行保存</p>
                </div>
            </div>
        </div>
        <div class="tip">
            仅供学习使用，<a href="#" target="_blank">原作者：zhouql.vip</a>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const videoUrlInput = document.getElementById('videoUrl');
            const downloadBtn = document.getElementById('downloadBtn');
            const videoUrlInfo = document.getElementById('videoUrlInfo');
            const imgUrlInfo = document.getElementById('imgUrlInfo');
            const videoNameElement = document.getElementById('videoName');
            const previewVideoElement = document.getElementById('previewVideo');
            const previewImageElement = document.getElementById('previewImage');
            const downloadVideoElement = document.getElementById('downloadVideo');

            let videoName = '';
            let downloadUrl = '';
            let bgUrl = '';
            let previewUrl = '';

            // 获取视频信息
            downloadBtn.addEventListener('click', function () {
                const userInput = videoUrlInput.value.trim();

                if (!userInput) {
                    alert('请输入视频链接或BV号');
                    return;
                }

                toggleLoading(true);

                fetch('/fetch', {
                    method: 'POST',
                    body: new URLSearchParams({ 'bv': userInput })
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP 错误: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data.video_name || !data.download_url || !data.preview_url) {
                        throw new Error('后端返回数据不完整');
                    }

                    videoName = data.video_name;
                    bgUrl = data.cover_url;
                    downloadUrl = data.download_url;
                    previewUrl = data.preview_url; // 获取预览视频的 URL

                    // 更新 UI
                    updateUI();
                })
                .catch(error => {
                    alert(`请求失败: ${error.message}`);
                })
                .finally(() => {
                    toggleLoading(false);
                });
            });

            // 更新 UI
            function updateUI() {
                videoNameElement.innerText = videoName;
                previewVideoElement.href = previewUrl;  // 直接链接到 B 站的视频
                previewImageElement.href = bgUrl;

                videoUrlInfo.style.display = 'block';
                imgUrlInfo.style.display = bgUrl ? 'block' : 'none';

                // 设置下载按钮
                downloadVideoElement.href = `/video?url=${encodeURIComponent(downloadUrl)}`; // 设置下载链接
                downloadVideoElement.download = `${videoName}.mp4`; // 设置下载文件的默认名称
            }

            // 切换按钮加载状态
            function toggleLoading(isLoading) {
                downloadBtn.disabled = isLoading;
                downloadBtn.innerText = isLoading ? "加载中..." : "获取";
            }
        });
    </script>
</body>
</html>
